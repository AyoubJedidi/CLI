# Build stage
FROM {{ docker_base_image }} AS build
WORKDIR /src

{% if has_solution %}
# Copy solution file
COPY *.sln ./
{% endif %}

# Copy all project folders containing csproj files
{% if csproj_paths %}
{% for path in csproj_paths %}
COPY {{ path }}/*.csproj {{ path }}/
{% endfor %}
{% endif %}

# Restore dependencies
{% if csproj_paths %}
{% for path in csproj_paths %}
WORKDIR /src/{{ path }}
RUN dotnet restore
{% endfor %}
{% else %}
RUN dotnet restore
{% endif %}

# Copy everything else and build
COPY . .
WORKDIR /src
RUN dotnet build --configuration Release --no-restore

{% if project_type == 'web' or is_web_app %}
# Publish
RUN dotnet publish --configuration Release --output /app/publish --no-build
{% endif %}

# Runtime stage
FROM {{ docker_runtime_image }}
WORKDIR /app

{% if project_type == 'web' or is_web_app %}
COPY --from=build /app/publish .

# Expose port
EXPOSE {{ docker_port }}

# Set environment variables
ENV ASPNETCORE_URLS=http://+:{{ docker_port }}

ENTRYPOINT ["dotnet", "{{ project_name }}.dll"]

{% else %}
# For console apps
COPY --from=build /src/bin/Release/net{{ dotnet_version }}/ .

ENTRYPOINT ["dotnet", "{{ project_name }}.dll"]
{% endif %}
