// Generated by cicd-framework
// Project: {{ project_name }}
// Language: Python {{ python_version }}
// Framework: {{ framework or 'N/A' }}
// Generated: {{ generation_date }}

pipeline {
    agent any

    environment {
        PYTHON_VERSION = '{{ python_version }}'
        PROJECT_NAME = '{{ project_name }}'
        VENV_PATH = 'venv'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "Setting up Python ${PYTHON_VERSION} environment..."
                    python${PYTHON_VERSION} -m venv ${VENV_PATH}
                    . ${VENV_PATH}/bin/activate
                    pip install --upgrade pip
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                {% if package_manager == 'pip' %}
                sh '''
                    . ${VENV_PATH}/bin/activate
                    {% if has_requirements_txt %}
                    pip install -r requirements.txt
                    {% endif %}
                    {% if has_requirements_dev %}
                    pip install -r requirements-dev.txt
                    {% endif %}
                '''
                {% elif package_manager == 'poetry' %}
                sh '''
                    pip install poetry
                    poetry install
                '''
                {% elif package_manager == 'pipenv' %}
                sh '''
                    pip install pipenv
                    pipenv install --dev
                '''
                {% endif %}
            }
        }

        {% if enable_linting %}
        stage('Lint') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install linters if not present
                    pip install flake8 black mypy 2>/dev/null || true

                    # Flake8
                    echo "Running flake8..."
                    flake8 {{ app_module }}/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

                    # Black
                    echo "Checking code formatting..."
                    black --check {{ app_module }}/ || true

                    # MyPy
                    echo "Running type checker..."
                    mypy {{ app_module }}/ || true
                '''
            }
        }
        {% endif %}

        stage('Test') {
            steps {
                {% if test_framework == 'pytest' %}
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install pytest if not present
                    pip install pytest pytest-cov 2>/dev/null || true

                    echo "Running tests with pytest..."
                    pytest tests/ \
                        --junitxml=test-results/junit.xml \
                        --cov={{ app_module }} \
                        --cov-report=xml:coverage.xml \
                        --cov-report=html:htmlcov \
                        --cov-report=term \
                        -v || true
                '''
                {% else %}
                sh '''
                    . ${VENV_PATH}/bin/activate
                    echo "Running tests with unittest..."
                    python -m unittest discover tests/ -v
                '''
                {% endif %}
            }
        }

        {% if enable_security_scan %}
        stage('Security Scan') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install security tools
                    pip install bandit safety 2>/dev/null || true

                    # Bandit (SAST)
                    echo "Running Bandit security scan..."
                    bandit -r {{ app_module }}/ -f json -o bandit-report.json || true

                    # Safety (dependency vulnerabilities)
                    echo "Checking dependencies for vulnerabilities..."
                    safety check --json --output safety-report.json || true
                '''
            }
        }
        {% endif %}

        {% if build_package %}
        stage('Build Package') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate
                    pip install build
                    python -m build
                '''
            }
        }
        {% endif %}

        {% if enable_docker %}
        stage('Docker Build') {
            steps {
                script {
                    def imageName = "${PROJECT_NAME}:${env.GIT_COMMIT_SHORT}"
                    sh "docker build -t ${imageName} ."
                    echo "Built Docker image: ${imageName}"
                }
            }
        }
        {% endif %}
    }

    post {
        always {
            // Clean up
            sh 'rm -rf ${VENV_PATH}' || true
        }
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
    }
}