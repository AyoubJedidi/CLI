# Build stage
FROM {{ docker_base_image }} AS build
WORKDIR /app

# Copy Maven wrapper and pom.xml
COPY .mvn .mvn
COPY mvnw pom.xml ./

{% if is_multi_module %}
# Multi-module: copy all module poms
COPY */pom.xml ./
{% endif %}

# Download dependencies
RUN ./mvnw dependency:go-offline -B || true

# Copy source code
COPY src ./src
{% if is_multi_module %}
COPY */src ./*/src
{% endif %}

# Build application
RUN ./mvnw package -DskipTests -B

# Runtime stage
FROM {{ docker_runtime_image }}
WORKDIR /app

# Copy JAR from build stage
COPY --from=build /app/target/*.{{ packaging }} app.{{ packaging }}

EXPOSE {{ docker_port }}

{% if packaging == 'war' %}
# For WAR files, you might need a servlet container
ENTRYPOINT ["java", "-jar", "app.war"]
{% else %}
ENTRYPOINT ["java", "-jar", "app.jar"]
{% endif %}