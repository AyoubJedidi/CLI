// Generated by cicd-framework
// Project: test-flask-app
// Language: Python 3.11
// Framework: flask
// Generated: 2025-11-14 16:19:59

pipeline {
    agent any

    environment {
        PYTHON_VERSION = '3.11'
        PROJECT_NAME = 'test-flask-app'
        VENV_PATH = 'venv'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "Setting up Python ${PYTHON_VERSION} environment..."
                    python${PYTHON_VERSION} -m venv ${VENV_PATH}
                    . ${VENV_PATH}/bin/activate
                    pip install --upgrade pip
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Lint') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install linters if not present
                    pip install flake8 black mypy 2>/dev/null || true

                    # Flake8
                    echo "Running flake8..."
                    flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

                    # Black
                    echo "Checking code formatting..."
                    black --check app/ || true

                    # MyPy
                    echo "Running type checker..."
                    mypy app/ || true
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install pytest if not present
                    pip install pytest pytest-cov 2>/dev/null || true

                    echo "Running tests with pytest..."
                    pytest tests/ \
                        --junitxml=test-results/junit.xml \
                        --cov=app \
                        --cov-report=xml:coverage.xml \
                        --cov-report=html:htmlcov \
                        --cov-report=term \
                        -v || true
                '''
            }
        }

        stage('Security Scan') {
            steps {
                sh '''
                    . ${VENV_PATH}/bin/activate

                    # Install security tools
                    pip install bandit safety 2>/dev/null || true

                    # Bandit (SAST)
                    echo "Running Bandit security scan..."
                    bandit -r app/ -f json -o bandit-report.json || true

                    # Safety (dependency vulnerabilities)
                    echo "Checking dependencies for vulnerabilities..."
                    safety check --json --output safety-report.json || true
                '''
            }
        }


        stage('Docker Build') {
            steps {
                script {
                    def imageName = "${PROJECT_NAME}:${env.GIT_COMMIT_SHORT}"
                    sh "docker build -t ${imageName} ."
                    echo "Built Docker image: ${imageName}"
                }
            }
        }
    }

    post {
        always {
            // Clean up
            sh 'rm -rf ${VENV_PATH}' || true
        }
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
    }
}